###############
#   Builder   #
###############
FROM maven:3.9.4-eclipse-temurin-17 AS builder
WORKDIR /app

# 1) Copia pom y c칩digo
COPY pom.xml .
COPY src ./src

# 2) Empaqueta sin tests y sin filtrar resources
RUN mvn package -B -DskipTests -Dmaven.resources.skip=true

###############
#   Runtime   #
###############
FROM eclipse-temurin:17-jre
WORKDIR /app

# Copiamos el JAR generado
ARG JAR=gestion-citas-0.0.1-SNAPSHOT.jar
COPY --from=builder /app/target/${JAR} app.jar

# --- Declaraci칩n de ARGs para Render ---
ARG SERVER_PORT=3000

# Datasource
ARG SPRING_DATASOURCE_URL
ARG SPRING_DATASOURCE_USERNAME
ARG SPRING_DATASOURCE_PASSWORD

# RabbitMQ est치ndar de Spring
ARG SPRING_RABBITMQ_HOST
ARG SPRING_RABBITMQ_PORT=5672
ARG SPRING_RABBITMQ_USERNAME
ARG SPRING_RABBITMQ_PASSWORD
ARG SPRING_RABBITMQ_VIRTUAL_HOST

# Tus tres vars punteadas:
ARG RABBITMQ_EXCHANGE
ARG RABBITMQ_QUEUE
ARG RABBITMQ_ROUTING_KEY

# Email
ARG SPRING_MAIL_HOST
ARG SPRING_MAIL_PORT=587
ARG SPRING_MAIL_USERNAME
ARG SPRING_MAIL_PASSWORD

# JWT / Login API
ARG JWT_SECRET
ARG LOGIN_API_URL

# --- Pasamos a ENV ---
ENV SERVER_PORT=${SERVER_PORT}

ENV SPRING_DATASOURCE_URL=${SPRING_DATASOURCE_URL}
ENV SPRING_DATASOURCE_USERNAME=${SPRING_DATASOURCE_USERNAME}
ENV SPRING_DATASOURCE_PASSWORD=${SPRING_DATASOURCE_PASSWORD}

ENV SPRING_RABBITMQ_HOST=${SPRING_RABBITMQ_HOST}
ENV SPRING_RABBITMQ_PORT=${SPRING_RABBITMQ_PORT}
ENV SPRING_RABBITMQ_USERNAME=${SPRING_RABBITMQ_USERNAME}
ENV SPRING_RABBITMQ_PASSWORD=${SPRING_RABBITMQ_PASSWORD}
ENV SPRING_RABBITMQ_VIRTUAL_HOST=${SPRING_RABBITMQ_VIRTUAL_HOST}

# Estas tres son las que tu c칩digo lee con @Value("${rabbitmq.exchange.name}") etc.
ENV RABBITMQ_EXCHANGE=${RABBITMQ_EXCHANGE}
ENV RABBITMQ_QUEUE=${RABBITMQ_QUEUE}
ENV RABBITMQ_ROUTING_KEY=${RABBITMQ_ROUTING_KEY}

ENV SPRING_MAIL_HOST=${SPRING_MAIL_HOST}
ENV SPRING_MAIL_PORT=${SPRING_MAIL_PORT}
ENV SPRING_MAIL_USERNAME=${SPRING_MAIL_USERNAME}
ENV SPRING_MAIL_PASSWORD=${SPRING_MAIL_PASSWORD}

ENV JWT_SECRET=${JWT_SECRET}
ENV LOGIN_API_URL=${LOGIN_API_URL}

EXPOSE ${SERVER_PORT}

ENTRYPOINT ["java","-jar","/app/app.jar"]
