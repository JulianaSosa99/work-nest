###############
#   Builder   #
###############
FROM maven:3.9.4-eclipse-temurin-17 AS builder
WORKDIR /app

# 1) Copia pom y código
COPY pom.xml .
COPY src ./src

# 2) Empaqueta sin tests y sin filtrar resources
RUN mvn package -B -DskipTests -Dmaven.resources.skip=true

###############
#   Runtime   #
###############
FROM eclipse-temurin:17-jre
WORKDIR /app

# Nombre del JAR a copiar (ajústalo si cambias versión/artifactId)
ARG JAR=gestion-citas-0.0.1-SNAPSHOT.jar
COPY --from=builder /app/target/${JAR} app.jar

# Construcción de vars de entorno (RENDER las sobreescribirá en Dashboard)
ARG SERVER_PORT=8080
ARG DB_URL
ARG DB_USER_NAME
ARG DB_PASSWORD
ARG RABBITMQ_HOST
ARG RABBITMQ_PORT
ARG RABBITMQ_USER_NAME
ARG RABBITMQ_PASSWORD
ARG RABBITMQ_VIRTUAL_HOST
ARG RABBITMQ_EXCHANGE
ARG RABBITMQ_QUEUE
ARG RABBITMQ_ROUTING_KEY
ARG MAIL_HOST
ARG MAIL_PORT
ARG MAIL_USERNAME
ARG MAIL_PASSWORD
ARG JWT_SECRET
ARG LOGIN_API_URL

# Pásalos al entorno de ejecución
ENV SERVER_PORT=${SERVER_PORT}
ENV DB_URL=${DB_URL}
ENV DB_USER_NAME=${DB_USER_NAME}
ENV DB_PASSWORD=${DB_PASSWORD}

ENV RABBITMQ_HOST=${RABBITMQ_HOST}
ENV RABBITMQ_PORT=${RABBITMQ_PORT}
ENV RABBITMQ_USER_NAME=${RABBITMQ_USER_NAME}
ENV RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD}
ENV RABBITMQ_VIRTUAL_HOST=${RABBITMQ_VIRTUAL_HOST}
ENV RABBITMQ_EXCHANGE=${RABBITMQ_EXCHANGE}
ENV RABBITMQ_QUEUE=${RABBITMQ_QUEUE}
ENV RABBITMQ_ROUTING_KEY=${RABBITMQ_ROUTING_KEY}

ENV MAIL_HOST=${MAIL_HOST}
ENV MAIL_PORT=${MAIL_PORT}
ENV MAIL_USERNAME=${MAIL_USERNAME}
ENV MAIL_PASSWORD=${MAIL_PASSWORD}

ENV JWT_SECRET=${JWT_SECRET}
ENV LOGIN_API_URL=${LOGIN_API_URL}

# Expone el puerto configurado
EXPOSE ${SERVER_PORT}

# Lanza la app
ENTRYPOINT ["java","-jar","/app/app.jar"]
